@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
' Include material icons
!define ICONURL https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/material
!define ICONURL2 https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/master/devicons2
!include ICONURL/cloud.puml
!include ICONURL2/redis.puml
!include ICONURL2/postgresql.puml
!include ICONURL2/vuejs.puml
!include ICONURL2/kotlin.puml
!include ICONURL2/spring.puml
!include ICONURL2/chrome.puml

LAYOUT_WITH_LEGEND()

Person(user, "User", "End user of the Portfolio Management System")

System_Boundary(portfolio_system, "Portfolio Management System") {
  Container(caddy, "Caddy", "Web Server", "Reverse proxy, routes auth and protected requests")
  Container(auth, "Auth Service", "Kotlin, Spring Boot", "OAuth2 authentication, session management, email/login whitelist", $sprite="spring")
  Container(frontend, "Frontend", "Vue.js, Bootstrap", "Provides the user interface for managing portfolio and viewing data", $sprite="vuejs")
  Container(backend, "Backend", "Kotlin, Spring Boot", "Handles API requests, processes data, and manages business logic", $sprite="kotlin")
  ContainerDb(database, "Database", "PostgreSQL", "Stores portfolio and financial data", $sprite="postgresql")
  ContainerDb(cache, "Cache", "Redis", "Caches session data and portfolio summaries", $sprite="redis")
  Container(cloudflare_bypass_proxy, "Cloudflare Bypass Proxy", "Node.js/TypeScript, curl-impersonate", "Bypasses Cloudflare protection with TLS fingerprint spoofing")
  ContainerDb(minio, "MinIO", "Object Storage", "S3-compatible storage for company logos")
}

System_Ext(binance, "Binance API", "Provides cryptocurrency prices", $sprite="cloud")
System_Ext(ft_markets, "FT Markets", "AJAX endpoint returning HTML fragments (parsed with Jsoup)", $sprite="cloud")
System_Ext(trading212_platform, "Trading212 Platform", "External trading platform for price data", $sprite="cloud")
System_Ext(lightyear, "Lightyear Website", "ETF holdings data via web scraping", $sprite="cloud")
System_Ext(wisdomtree, "WisdomTree Website", "ETF holdings HTML (parsed with Jsoup)", $sprite="cloud")
System_Ext(openrouter, "OpenRouter API", "AI service for ETF sector classification (Claude Haiku)", $sprite="cloud")
System_Ext(google_vision, "Google Cloud Vision", "OCR service for captcha solving", $sprite="cloud")
System_Ext(telegram, "Telegram Bot API", "Notification service", $sprite="cloud")
System_Ext(google_oauth, "Google OAuth", "External identity provider", $sprite="cloud")
System_Ext(github_oauth, "GitHub OAuth", "External identity provider", $sprite="cloud")

Container_Ext(browser, "Browser", "Chrome, LocalStorage, Cookies", "Stores auth session cookies", $sprite="chrome")

Rel(user, browser, "Uses", "HTTPS")
Rel(browser, caddy, "Accesses", "HTTP :80")
Rel(caddy, auth, "Routes /login, /oauth2/*, /logout", "HTTP :8083")
Rel(caddy, auth, "Validates requests via forward_auth", "HTTP :8083/validate")
Rel(auth, google_oauth, "Delegates authentication", "OAuth2/OIDC")
Rel(auth, github_oauth, "Delegates authentication", "OAuth2")
Rel(auth, cache, "Stores sessions", "Redis protocol")
Rel(caddy, backend, "Routes /api/*", "HTTP :8080")
Rel(caddy, frontend, "Routes UI requests", "HTTP :80")
Rel(frontend, backend, "API calls", "via proxy")
Rel(backend, database, "Reads/writes data", "JDBC")
Rel(backend, cache, "Caches data", "Redis protocol")
Rel(backend, binance, "Fetches crypto prices", "HTTPS/JSON")
Rel(backend, ft_markets, "Fetches HTML fragments", "HTTPS/Jsoup")
Rel(backend, cloudflare_bypass_proxy, "Requests prices", "HTTP :3000")
Rel(cloudflare_bypass_proxy, trading212_platform, "Fetches price data", "HTTPS")
Rel(backend, cloudflare_bypass_proxy, "Requests ETF holdings", "HTTP :3000/wisdomtree")
Rel(cloudflare_bypass_proxy, wisdomtree, "Fetches HTML", "HTTPS")
Rel(backend, cloudflare_bypass_proxy, "Requests price data", "HTTP :3000/lightyear")
Rel(cloudflare_bypass_proxy, lightyear, "Fetches price data", "HTTPS")
Rel(backend, lightyear, "Scrapes ETF holdings", "Selenide")
Rel(backend, minio, "Stores/retrieves logos", "S3 API")
Rel(backend, openrouter, "AI classification", "HTTPS")
Rel(backend, google_vision, "OCR captcha solving", "HTTPS")
Rel(backend, telegram, "Sends notifications", "HTTPS")

@enduml
