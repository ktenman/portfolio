www.fov.ee {
    redir https://fov.ee{uri}
}

fov.ee {
    encode gzip

    # Redirect all HTTP traffic to HTTPS
    @http {
        protocol http
    }
    redir @http https://fov.ee{uri}

    # Captcha solver routes with proper handling
    @captcha_routes {
        path /captcha /captcha/*
    }
    handle @captcha_routes {
        uri strip_prefix /captcha
        reverse_proxy captcha-solver:8000 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
        }
    }

    # Login and OAuth routes are handled by the auth server
    @auth_routes {
        path /login /login/* /oauth2/* /logout
    }
    handle @auth_routes {
        reverse_proxy auth:8083
    }

    # Captcha solver routes with proper handling
    @captcha_routes {
        path /captcha /captcha/* /captcha/docs /captcha/docs/* /captcha/openapi.json /captcha/redoc /captcha/redoc/* /captcha/static/* /openapi.json
    }
    handle @captcha_routes {
        uri strip_prefix /captcha
        reverse_proxy captcha-solver:8000 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
        }
    }

    # Unprotected API calculator route for backend
    handle /api/calculator {
        reverse_proxy backend:8080
    }

    @protected {
        not path /login /login/* /oauth2/* /logout /calculator /calculator/* /assets/* *.js *.css *.svg /api/calculator /captcha /captcha/* /captcha/docs /captcha/docs/* /captcha/openapi.json /captcha/redoc /captcha/redoc/* /captcha/static/* /openapi.json
    }

    handle @protected {
        forward_auth auth:8083 {
            uri /validate
            copy_headers X-User-Id
        }

        # API routes
        @api {
            path /api/*
        }
        handle @api {
            reverse_proxy backend:8080
        }

        # All other routes go to the frontend
        reverse_proxy frontend:80
    }
}
