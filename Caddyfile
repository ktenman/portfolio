# Captcha subdomain
captcha.fov.ee {
    # First handle exact root redirects
    @root {
        path_regexp ^/?$
    }
    handle @root {
        redir https://captcha.fov.ee/docs permanent
    }

    # Then proxy everything else
    handle * {
        reverse_proxy captcha-solver:8000 {
            header_up X-Real-IP {remote_host}
        }
    }
}

# Main domain and www redirect
www.fov.ee {
    redir https://fov.ee{uri}
}

# Main domain
fov.ee {
    encode gzip

    # Redirect all HTTP traffic to HTTPS
    @http {
        protocol http
    }
    redir @http https://fov.ee{uri}

    # ============ PUBLIC ROUTES - NO AUTHENTICATION ============

    # PUBLIC: Calculator frontend (must come before protected routes)
    @public_calculator {
        path /calculator
        path /calculator/*
    }
    handle @public_calculator {
        # Skip authentication check entirely
        header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate"
        header Pragma "no-cache"
        header Expires "0"
        reverse_proxy frontend:80
    }

    # PUBLIC: Calculator API endpoint
    handle /api/calculator {
        # Explicitly allow cross-origin requests
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        reverse_proxy backend:8080
    }

    # PUBLIC: Static assets needed by calculator
    @public_assets {
        path /assets/*
        path *.js
        path *.css
        path *.svg
    }
    handle @public_assets {
        header Cache-Control "public, max-age=3600"
        reverse_proxy frontend:80
    }

    # ============ AUTH ROUTES ============

    # Login and OAuth routes
    @auth_routes {
        path /login
        path /login/*
        path /oauth2/*
        path /logout
    }
    handle @auth_routes {
        reverse_proxy auth:8083
    }

    # ============ PROTECTED ROUTES ============

    # Everything else not already handled is protected
    handle {
        # This will catch all paths not handled above
        forward_auth auth:8083 {
            uri /validate
            copy_headers X-User-Id
        }

        # API routes
        @api {
            path /api/*
        }
        handle @api {
            reverse_proxy backend:8080
        }

        # All other protected routes
        reverse_proxy frontend:80
    }
}
