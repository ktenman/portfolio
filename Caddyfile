{
    order cache before rewrite
    cache {
        log_level debug
        ttl 1h
        stale 3h
        default_cache_control public, max-age=3600
        redis {
            url redis:6379
        }
    }
}

www.fov.ee {
    redir https://fov.ee{uri}
}

fov.ee {
    encode gzip

    @http {
        protocol http
    }
    redir @http https://fov.ee{uri}

    @healthcheck {
        path /healthz
    }
    handle @healthcheck {
        respond "OK" 200
    }

    @auth_routes {
        path /login /login/* /oauth2/* /logout
    }
    handle @auth_routes {
        reverse_proxy auth:8083
    }

    @protected {
        not path /login /login/* /oauth2/* /logout /healthz
    }
    handle @protected {
        forward_auth auth:8083 {
            uri /validate
            copy_headers X-User-Id
        }

        @api {
            path /api/*
        }
        handle @api {
            reverse_proxy backend:8080
        }

        handle {
            reverse_proxy frontend:80
        }
    }

    handle {
        cache {
            redis {
                url redis:6379
            }
            ttl 5m
        }
    }

    # Caching for /validate endpoint
    @validate {
        path /validate
    }
    handle @validate {
        cache {
            ttl 1m
        }
        reverse_proxy auth:8083
    }

    # Don't cache specific endpoints
    @no_cache {
        path /login /login/* /oauth2/* /logout /healthz
    }
    handle @no_cache {
        cache {
            default_cache_control no-store
        }
        reverse_proxy auth:8083
    }
}
