www.fov.ee {
    redir https://fov.ee{uri}
}

fov.ee {
    encode gzip

    @cacheable {
        not path /login /login/* /oauth2/* /logout /validate /validate/*
    }

    @cache_validate {
        path /validate /validate/*
    }

    @auth_routes {
        path /login /login/* /oauth2/* /logout
    }

    @api {
        path /api/*
    }

    cache {
        ttl 300s
        match {
            header Content-Type text/*
        }
    }

    handle @cacheable {
        reverse_proxy frontend:80
    }

    handle @cache_validate {
        cache {
            ttl 60s
        }
        reverse_proxy auth:8083
    }

    handle @auth_routes {
        reverse_proxy auth:8083
    }

    handle {
        forward_auth auth:8083 {
            uri /validate
            copy_headers X-User-Id
        }

        handle @api {
            reverse_proxy backend:8080
        }

        reverse_proxy frontend:80
    }
}
