# Main domain
fov.ee {
  encode gzip
  # Redirect all HTTP traffic to HTTPS
  @http {
    protocol http
  }
  redir @http https://fov.ee{uri}

  # Calculator related routes - public
  @calculator_routes {
    path /calculator /calculator/* /assets/* *.js *.css *.svg
  }
  handle @calculator_routes {
    header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate"
    header Pragma "no-cache"
    header Expires "0"
    reverse_proxy frontend:80
  }

  # Keycloak admin and auth endpoints
  handle /auth/* {
    reverse_proxy keycloak:8080
  }

  # Unprotected API calculator route
  handle /api/calculator {
    reverse_proxy backend:8080
  }

  # Health check endpoint
  handle /healthz {
    respond "OK" 200
  }

  # Access denied page
  handle /access-denied {
    respond 403 {
      body "Access denied. Please contact the administrator if you believe this is an error."
    }
  }

  # Protected routes
  @protected {
    not path /auth/* /calculator /calculator/* /assets/* *.js *.css *.svg /api/calculator /healthz /access-denied
  }
  handle @protected {
    # Use Keycloak for authentication
    forward_auth keycloak-gatekeeper:3000 {
      uri /oauth/validate
      copy_headers X-User-Email X-User-Name X-User-Id
    }

    # API routes
    @api {
      path /api/*
    }
    handle @api {
      reverse_proxy backend:8080
    }

    # All other routes go to frontend
    reverse_proxy frontend:80
  }

  log {
    output file /var/log/caddy/access.log
    format json
  }
}
