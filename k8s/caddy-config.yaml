apiVersion: v1
kind: ConfigMap
metadata:
  name: caddy-config
  namespace: portfolio
data:
  Caddyfile: |
    {
        email ktenman@gmail.com
        # Enable automatic HTTPS
    }

    # ──────────────── HTTP Health Checks (Port 80) ────────────────
    # This block handles health checks on HTTP port 80 directly
    # without any redirects, solving the Kubernetes probe warnings
    :80 {
        # Handle health checks for all domains on HTTP
        handle_path /healthz {
            respond "OK" 200
        }

        # Handle health checks with any domain header
        @health_check {
            path /healthz
        }
        handle @health_check {
            respond "OK" 200
        }

        # For all other requests on HTTP, redirect to HTTPS
        handle {
            redir https://{host}{uri} permanent
        }
    }

    # ──────────────── fov.ee (HTTPS) ────────────────
    fov.ee {
        # Health check endpoint for HTTPS as well (for completeness)
        handle_path /healthz {
            respond "OK" 200
        }

        # API endpoints
        handle /api/* {
            reverse_proxy backend:8080
        }

        # Auth routes
        @auth_routes {
            path /login /login/* /oauth2/* /logout
        }
        handle @auth_routes {
            reverse_proxy auth:8083
        }

        # Calculator routes
        handle /calculator* {
            reverse_proxy frontend:80
        }

        # Default to frontend
        handle {
            reverse_proxy frontend:80
        }
    }

    # www redirect (HTTPS)
    www.fov.ee {
        redir https://fov.ee{uri} permanent
    }

    # ──────────────── captcha.fov.ee (HTTPS) ────────────────
    captcha.fov.ee {
        handle_path /healthz {
            respond "OK" 200
        }

        # Root redirects
        @root {
            path_regexp ^/?$
        }
        handle @root {
            redir https://captcha.fov.ee/docs permanent
        }

        # All other paths
        handle * {
            reverse_proxy captcha-solver:8000
        }
    }

    # ──────────────── calculator.fov.ee (HTTPS) ────────────────
    calculator.fov.ee {
        handle_path /healthz {
            respond "OK" 200
        }

        # Root redirects
        handle / {
            redir /calculator permanent
        }

        # Calculator frontend
        handle /calculator* {
            reverse_proxy frontend:80
        }

        # Calculator API
        handle /api/calculator {
            reverse_proxy backend:8080
        }

        # Static assets
        handle {
            reverse_proxy frontend:80
        }
    }
